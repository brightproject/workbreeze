#!/usr/bin/php
<?php

define('PUBLIC_DIR', dirname(dirname(dirname(__FILE__))) . DIRECTORY_SEPARATOR . 'public_html' . DIRECTORY_SEPARATOR);
define('PUBLIC_JOBS_DIR', PUBLIC_DIR . 'jobs' . DIRECTORY_SEPARATOR);

// something like config
require dirname(dirname(__FILE__)) . '/defines.php';

// requiring helpers
require 'scheduler.php';

// initialize mongo connection
try {
	$mongo = new Mongo();
} catch (MongoConnectionException $e) {
	die("Can't connect to mongo db\n");
}

$dbname = DB;

$db = $mongo->$dbname;

// lets do it
$scheduler = new Scheduler($db);

$action = isset($argv[1]) ? $argv[1] : 'joblist';

$lockname = 'lock_' . $action . '.tmp';

if (file_exists($lockname))
	die();

touch($lockname);

if ('joblist' === $action) {
	$scheduler->processJobList();
} else
if ('queue' === $action) {
	$scheduler->processQueue();
}

unlink($lockname);
